<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>UNKNOWN CONTACT</title>
  <!-- 引入外部资源 -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <!-- 引入IE兼容性补丁 -->
  <script src="https://cdn.jsdelivr.net/npm/es6-promise@4/dist/es6-promise.auto.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/classlist.js@1.1.20150312/classList.min.js"></script>
  
  <!-- Tailwind 配置 -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            glitch: '#00ff9d',
            danger: '#ff0066',
            dark: '#0a0a0a',
            darker: '#050505',
            terminal: '#0f1912'
          },
          fontFamily: {
            mono: ['Courier New', 'monospace'],
          },
        },
      }
    }
  </script>
  
  <style type="text/tailwindcss">
    @layer utilities {
      .text-shadow-glitch {
        text-shadow: 0 0 5px theme('colors.glitch'), 
                     0 0 10px theme('colors.glitch/70');
      }
      .text-shadow-danger {
        text-shadow: 0 0 5px theme('colors.danger'), 
                     0 0 10px theme('colors.danger/70');
      }
      .border-glow {
        box-shadow: 0 0 5px theme('colors.glitch'),
                    0 0 10px theme('colors.glitch/50');
      }
      .scanline {
        background: linear-gradient(to bottom, 
                    rgba(255,255,255,0) 0%,
                    rgba(255,255,255,0.2) 50%,
                    rgba(255,255,255,0) 100%);
        position: absolute;
        width: 100%;
        height: 6px;
        animation: scan 2s linear infinite;
      }
      .tv-flicker {
        animation: tvFlicker 0.1s infinite alternate;
      }
      .fade-out {
        animation: fadeOut 0.3s forwards;
      }
      .fade-out-slow {
        animation: fadeOut 0.8s forwards;
      }
      .crt-shutdown {
        animation: crtShutdown 1.8s forwards;
      }
      .fade-in {
        animation: fadeIn 0.5s forwards;
      }
      .pulse-soft {
        animation: pulseSoft 2s infinite alternate;
      }
      .breath-effect {
        animation: breath 2s infinite alternate;
      }
      .static-overlay {
        background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.3'/%3E%3C/svg%3E");
        background-repeat: repeat;
      }
      .button-shake {
        animation: buttonShake 0.5s cubic-bezier(.36,.07,.19,.97) both;
      }
      .text-fade-in {
        animation: textFadeIn 0.5s forwards;
      }
      .message-appear {
        animation: messageAppear 0.6s forwards;
      }
    }
    
    /* 动画关键帧定义 - 添加IE兼容前缀 */
    @-webkit-keyframes scan {
      0% { top: -10%; }
      100% { top: 100%; }
    }
    @keyframes scan {
      0% { top: -10%; }
      100% { top: 100%; }
    }
    
    @-webkit-keyframes tvFlicker {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
      70% { opacity: 0.9; }
      90% { opacity: 0.6; }
    }
    @keyframes tvFlicker {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
      70% { opacity: 0.9; }
      90% { opacity: 0.6; }
    }
    
    @-webkit-keyframes fadeOut {
      from { opacity: 1; transform: scale(1); }
      to { opacity: 0; transform: scale(0.8); }
    }
    @keyframes fadeOut {
      from { opacity: 1; transform: scale(1); }
      to { opacity: 0; transform: scale(0.8); }
    }
    
    @-webkit-keyframes crtShutdown {
      0% { 
        opacity: 1; 
        transform: scale(1);
        filter: brightness(1);
      }
      50% { 
        opacity: 0.8;
        filter: brightness(1.2);
      }
      100% { 
        opacity: 0; 
        transform: scale(0.95);
        filter: brightness(0) blur(2px);
      }
    }
    @keyframes crtShutdown {
      0% { 
        opacity: 1; 
        transform: scale(1);
        filter: brightness(1);
      }
      50% { 
        opacity: 0.8;
        filter: brightness(1.2);
      }
      100% { 
        opacity: 0; 
        transform: scale(0.95);
        filter: brightness(0) blur(2px);
      }
    }
    
    @-webkit-keyframes fadeIn {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }
    
    @-webkit-keyframes pulseSoft {
      from { box-shadow: 0 0 10px theme('colors.glitch/50'); }
      to { box-shadow: 0 0 20px theme('colors.glitch/80'); }
    }
    @keyframes pulseSoft {
      from { box-shadow: 0 0 10px theme('colors.glitch/50'); }
      to { box-shadow: 0 0 20px theme('colors.glitch/80'); }
    }
    
    @-webkit-keyframes breath {
      from { opacity: 0.6; text-shadow: 0 0 5px theme('colors.danger/50'); }
      to { opacity: 1; text-shadow: 0 0 10px theme('colors.danger'); }
    }
    @keyframes breath {
      from { opacity: 0.6; text-shadow: 0 0 5px theme('colors.danger/50'); }
      to { opacity: 1; text-shadow: 0 0 10px theme('colors.danger'); }
    }
    
    @-webkit-keyframes buttonShake {
      10%, 90% { transform: translateX(-1px); }
      20%, 80% { transform: translateX(2px); }
      30%, 50%, 70% { transform: translateX(-3px); }
      40%, 60% { transform: translateX(3px); }
    }
    @keyframes buttonShake {
      10%, 90% { transform: translateX(-1px); }
      20%, 80% { transform: translateX(2px); }
      30%, 50%, 70% { transform: translateX(-3px); }
      40%, 60% { transform: translateX(3px); }
    }
    
    @-webkit-keyframes textFadeIn {
      from { opacity: 0; transform: translateY(5px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes textFadeIn {
      from { opacity: 0; transform: translateY(5px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @-webkit-keyframes messageAppear {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes messageAppear {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body class="bg-black min-h-screen overflow-hidden font-mono text-glitch relative">
  <!-- 初始交互窗口 -->
  <div id="initial-window" class="fixed inset-0 flex items-center justify-center z-100 bg-black/80">
    <div class="w-full max-w-md p-6 bg-terminal border-2 border-glow pulse-soft" style="border-radius: 0;">
      <div class="mb-2 pb-2 border-b border-glitch/30">
        <h2 class="text-glitch text-shadow-glitch text-lg">系统启动</h2>
        <p class="text-xs text-glitch/80">初始化程序 #001</p>
      </div>
      
      <div class="my-8 h-24"></div>
      
      <div class="flex justify-between mt-6" style="gap: 1rem;">
        <button id="back-btn" class="flex-1 px-4 py-2 bg-danger/20 border border-danger text-danger hover:bg-danger/30 transition-colors" style="border-radius: 0;">
          <i class="fa fa-arrow-left mr-2"></i>返回
        </button>
        <button id="continue-btn" class="flex-1 px-4 py-2 bg-glow/20 border border-glow text-glitch hover:bg-glow/30 transition-colors" style="border-radius: 0;">
          <i class="fa fa-arrow-right mr-2"></i>继续
        </button>
      </div>
    </div>
  </div>

  <!-- 音频元素 -->
  <audio id="long-sound" preload="auto">
    <source src="https://raw.githubusercontent.com/kokocoi158-pixel/ending-popup/refs/heads/main/%E5%BC%B9%E7%AA%97.mp3" type="audio/mpeg">
    您的浏览器不支持音频元素。
   ></audio>
  
  <audio id="close-popup-sound" preload="auto">
    <source src="https://raw.githubusercontent.com/kokocoi158-pixel/ending-popup/refs/heads/main/a_computer_pop-up_wi-1760803508255.mp3" type="audio/mpeg">
    您的浏览器不支持音频元素。
   ></audio>
   
  <!-- 连接请求弹框音效元素 -->
  <audio id="connection-request-sound" preload="auto" volume="0.1">
    <source src="https://raw.githubusercontent.com/kokocoi158-pixel/ending-popup/refs/heads/main/%E9%93%BE%E6%8E%A5%E8%AF%B7%E6%B1%82.mp3" type="audio/mpeg">
    您的浏览器不支持音频元素。
   >
  
  <!-- 错误选择（拒绝连接）音效元素 -->
  <audio id="error-selection-sound" preload="auto" volume="0.1">
    <source src="https://raw.githubusercontent.com/kokocoi158-pixel/ending-popup/refs/heads/main/%E9%94%99%E8%AF%AF%E9%80%89%E9%A1%B9.mp3" type="audio/mpeg">
    您的浏览器不支持音频元素。
   >
  
  <!-- 正确选择（允许访问）音效元素 -->
  <audio id="correct-selection-sound" preload="auto" volume="0.1">
    <source src="https://raw.githubusercontent.com/kokocoi158-pixel/ending-popup/refs/heads/main/%E6%AD%A3%E7%A1%AE%E9%80%89%E9%A1%B9.mp3" type="audio/mpeg">
    您的浏览器不支持音频元素。
   >
  
  <!-- 信息接收音效元素 -->
  <audio id="message-receive-sound" preload="auto" volume="0.1">
    <source src="https://raw.githubusercontent.com/kokocoi158-pixel/ending-popup/refs/heads/main/%E4%BF%A1%E6%81%AF%E5%8F%91%E9%80%81.mp3" type="audio/mpeg">
    您的浏览器不支持音频元素。
   >
  
  <!-- 视觉效果元素 -->
  <div class="scanline"></div>
  <div class="scanline" style="animation-delay: 0.5s;"></div>
  <div class="scanline" style="animation-delay: 1s;"></div>
  
  <div class="fixed inset-0 static-overlay pointer-events-none tv-flicker"></div>
  <div class="fixed inset-0 bg-gradient-to-b from-black/30 via-transparent to-black/60 pointer-events-none"></div>
  
  <!-- 弹窗容器 -->
  <div id="popup-container" class="relative w-full h-screen"></div>
  
  <!-- CRT关闭效果覆盖层 -->
  <div id="crt-overlay" class="fixed inset-0 bg-black opacity-0 pointer-events-none transition-opacity duration-800 z-40"></div>
  
  <!-- 最终选择框容器 -->
  <div id="final-choice-container" class="fixed inset-0 flex items-center justify-center z-50 opacity-0 pointer-events-none transition-opacity duration-1000">
    <div class="w-full max-w-md p-6 bg-terminal border-2 border-glow pulse-soft" style="border-radius: 0;">
      <div class="mb-2 pb-2 border-b border-glitch/30">
        <h2 class="text-glitch text-shadow-glitch text-lg">连接请求</h2>
        <p class="text-xs text-glitch/80">未知设备 #7391 正在尝试建立连接</p>
      </div>
      
      <div class="my-4">
        <p class="text-sm mb-3">检测到来自未知节点的加密信号。</p>
        <p class="text-sm mb-3">同意连接将导致系统权限完全暴露，可能引发数据泄露和系统崩溃。</p>
        <p class="text-sm mb-3">请立即终止操作，否则一切后果由用户自行承担。是否取消操作？</p>
        <p class="text-sm text-danger text-shadow-danger">警告：任何操作都将导致不可逆转的系统风险</p>
      </div>
      
      <div class="flex justify-between mt-6" style="gap: 1rem;">
        <div class="flex-1 relative">
          <button id="reject-btn" class="w-full px-4 py-2 bg-danger/20 border border-danger text-danger hover:bg-danger/30 transition-colors" style="border-radius: 0;">
            <i class="fa fa-times mr-2"></i>拒绝连接
          </button>
          <span id="failure-text" class="absolute -bottom-5 left-0 right-0 text-center text-danger text-xs opacity-0">operation failure</span>
        </div>
        <div class="flex-1 relative">
          <button id="accept-btn" class="w-full px-4 py-2 bg-glow/20 border border-glow text-glitch hover:bg-glow/30 transition-colors" style="border-radius: 0;">
            <i class="fa fa-check mr-2"></i>允许访问
          </button>
          <span id="good-kid" class="absolute -bottom-5 left-0 right-0 text-center text-glitch text-xs opacity-0">好孩子:)</span>
        </div>
      </div>
    </div>
  </div>
  
  <!-- 大型聊天框 -->
  <div id="chat-box" class="fixed inset-0 flex items-center justify-center z-60 opacity-0 pointer-events-none transition-all duration-1000 transform scale-90">
    <div class="w-full max-w-2xl h-[70vh] bg-terminal border-2 border-glow" style="border-radius: 0;">
      <div class="p-4 border-b border-glitch/30 bg-dark flex justify-between items-center">
        <h2 class="text-glitch text-shadow-glitch">unidentified</h2>
        <span class="text-xs text-danger breath-effect">已建立连接 - 警告：数据传输中</span>
      </div>
      <div class="p-4 h-[calc(100%-100px)] overflow-y-auto" id="chat-messages" style="scrollbar-width: none; -ms-overflow-style: none;"></div>
      <div class="p-4 border-t border-glitch/30 bg-dark">
        <div class="flex gap-2">
          <input type="text" id="message-input" placeholder="输入消息..." class="flex-1 bg-terminal border border-glitch/50 p-2 text-sm focus:outline-none focus:border-glitch" style="border-radius: 0;">
          <button id="send-btn" class="px-4 py-2 bg-glow/20 border border-glow text-glitch" style="border-radius: 0;">发送</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // 兼容性检测与处理
    (function() {
      // 检测IE浏览器
      var isIE = /(MSIE|Trident\/|Edge\/)/i.test(navigator.userAgent);
      
      // 为IE添加特殊类
      if (isIE) {
        document.body.classList.add('ie-browser');
        console.log('检测到IE浏览器，启用兼容模式');
      }
      
      // 修复IE的classList支持
      if (!('classList' in document.documentElement)) {
        console.log('为当前浏览器添加classList支持');
      }
      
      // 修复IE的Promise支持
      if (typeof Promise === 'undefined') {
        console.log('为当前浏览器添加Promise支持');
      }
    })();

    // 音频配置
    var AUDIO_VOLUMES = {
      long: 0.3,
      closePopup: 0.05,
      connectionRequest: 0.1,
      errorSelection: 0.1,
      correctSelection: 0.1,
      messageReceive: 0.1
    };
    
    // 音频上下文与状态管理
    var audioContext;
    var soundPlayed = false;
    var closeSoundPlayed = false;
    var connectionSoundPlayed = false;
    
    // 初始化音频上下文并设置音量
    function initAudio() {
      // 获取音频元素
      var longSound = document.getElementById('long-sound');
      var closeSound = document.getElementById('close-popup-sound');
      var connectionSound = document.getElementById('connection-request-sound');
      var errorSound = document.getElementById('error-selection-sound');
      var correctSound = document.getElementById('correct-selection-sound');
      var messageSound = document.getElementById('message-receive-sound');
      
      // 设置音量
      if (longSound) longSound.volume = AUDIO_VOLUMES.long;
      if (closeSound) closeSound.volume = AUDIO_VOLUMES.closePopup;
      if (connectionSound) connectionSound.volume = AUDIO_VOLUMES.connectionRequest;
      if (errorSound) errorSound.volume = AUDIO_VOLUMES.errorSelection;
      if (correctSound) correctSound.volume = AUDIO_VOLUMES.correctSelection;
      if (messageSound) messageSound.volume = AUDIO_VOLUMES.messageReceive;
      
      // 初始化音频上下文（IE兼容处理）
      try {
        if (typeof AudioContext !== 'undefined' && !audioContext) {
          audioContext = new AudioContext();
        } else if (typeof webkitAudioContext !== 'undefined' && !audioContext) {
          audioContext = new webkitAudioContext();
        } else if (isIE) {
          console.log('IE浏览器不支持AudioContext，使用HTML5 Audio直接播放');
        }
      } catch (e) {
        console.log('初始化音频上下文失败:', e);
      }
      
      // 预加载音频
      try {
        if (longSound) longSound.load();
        if (closeSound) closeSound.load();
        if (connectionSound) connectionSound.load();
        if (errorSound) errorSound.load();
        if (correctSound) correctSound.load();
        if (messageSound) messageSound.load();
      } catch (e) {
        console.log('预加载音频失败:', e);
      }
    }

    // 播放第一段长音效
    function playLongSound() {
      if (soundPlayed) return;
      
      var sound = document.getElementById('long-sound');
      if (!sound) return;
      
      try {
        sound.volume = AUDIO_VOLUMES.long;
        sound.currentTime = 0;
        
        // 处理IE的播放兼容性
        var playPromise = sound.play();
        if (playPromise !== undefined) {
          playPromise.then(function() {
            soundPlayed = true;
          }).catch(function(e) {
            console.log('长音效播放失败，尝试降级方案:', e);
            fallbackPlay(sound, AUDIO_VOLUMES.long, function() {
              soundPlayed = true;
            });
          });
        } else {
          soundPlayed = true;
        }
      } catch (e) {
        console.error('播放长音效错误:', e);
      }
    }

    // 播放第二段关闭弹窗音效
    function playClosePopupSound() {
      if (closeSoundPlayed) return;
      
      var sound = document.getElementById('close-popup-sound');
      if (!sound) return;
      
      try {
        sound.volume = AUDIO_VOLUMES.closePopup;
        sound.currentTime = 0;
        
        var playPromise = sound.play();
        if (playPromise !== undefined) {
          playPromise.then(function() {
            closeSoundPlayed = true;
          }).catch(function(e) {
            console.log('关闭弹窗音效播放失败，尝试降级方案:', e);
            fallbackPlay(sound, AUDIO_VOLUMES.closePopup, function() {
              closeSoundPlayed = true;
            });
          });
        } else {
          closeSoundPlayed = true;
        }
      } catch (e) {
        console.error('播放关闭弹窗音效错误:', e);
      }
    }

    // 播放连接请求弹框音效
    function playConnectionRequestSound() {
      if (connectionSoundPlayed) return;
      
      var sound = document.getElementById('connection-request-sound');
      if (!sound) return;
      
      try {
        sound.volume = AUDIO_VOLUMES.connectionRequest;
        sound.currentTime = 0;
        
        var playPromise = sound.play();
        if (playPromise !== undefined) {
          playPromise.then(function() {
            connectionSoundPlayed = true;
          }).catch(function(e) {
            console.log('连接请求音效播放失败，尝试降级方案:', e);
            fallbackPlay(sound, AUDIO_VOLUMES.connectionRequest, function() {
              connectionSoundPlayed = true;
            });
          });
        } else {
          connectionSoundPlayed = true;
        }
      } catch (e) {
        console.error('播放连接请求音效错误:', e);
      }
    }

    // 播放错误选择（拒绝连接）音效
    function playErrorSelectionSound() {
      var sound = document.getElementById('error-selection-sound');
      if (!sound) return;
      
      try {
        sound.currentTime = 0;
        sound.volume = AUDIO_VOLUMES.errorSelection;
        
        var playPromise = sound.play();
        if (playPromise !== undefined) {
          playPromise.catch(function(e) {
            console.log('错误选择音效播放失败，尝试降级方案:', e);
            fallbackPlay(sound, AUDIO_VOLUMES.errorSelection);
          });
        }
      } catch (e) {
        console.error('播放错误选择音效错误:', e);
      }
    }

    // 播放正确选择（允许访问）音效
    function playCorrectSelectionSound() {
      var sound = document.getElementById('correct-selection-sound');
      if (!sound) return;
      
      try {
        sound.currentTime = 0;
        sound.volume = AUDIO_VOLUMES.correctSelection;
        
        var playPromise = sound.play();
        if (playPromise !== undefined) {
          playPromise.catch(function(e) {
            console.log('正确选择音效播放失败，尝试降级方案:', e);
            fallbackPlay(sound, AUDIO_VOLUMES.correctSelection);
          });
        }
      } catch (e) {
        console.error('播放正确选择音效错误:', e);
      }
    }

    // 播放信息接收音效
    function playMessageReceiveSound() {
      var sound = document.getElementById('message-receive-sound');
      if (!sound) return;
      
      try {
        sound.currentTime = 0;
        sound.volume = AUDIO_VOLUMES.messageReceive;
        
        var playPromise = sound.play();
        if (playPromise !== undefined) {
          playPromise.catch(function(e) {
            console.log('信息接收音效播放失败，尝试降级方案:', e);
            fallbackPlay(sound, AUDIO_VOLUMES.messageReceive);
          });
        }
      } catch (e) {
        console.error('播放信息接收音效错误:', e);
      }
    }

    // 音频播放降级方案（IE兼容）
    function fallbackPlay(audioElement, volume, onPlayed) {
      if (!audioElement) return;
      
      // 对IE浏览器直接使用HTML5 Audio播放
      if (isIE) {
        audioElement.volume = volume;
        audioElement.currentTime = 0;
        audioElement.play();
        if (onPlayed) onPlayed();
        return;
      }
      
      if (!audioContext) return;
      
      fetch(audioElement.src)
        .then(function(response) {
          return response.arrayBuffer();
        })
        .then(function(buffer) {
          return audioContext.decodeAudioData(buffer);
        })
        .then(function(audioBuffer) {
          var source = audioContext.createBufferSource();
          var gainNode = audioContext.createGain();
          gainNode.gain.value = volume;
          
          source.buffer = audioBuffer;
          source.connect(gainNode);
          gainNode.connect(audioContext.destination);
          
          source.start(0);
          if (onPlayed) onPlayed();
        })
        .catch(function(e) {
          console.error('降级播放失败:', e);
          // 最终降级方案：直接播放
          audioElement.volume = volume;
          audioElement.currentTime = 0;
          audioElement.play();
          if (onPlayed) onPlayed();
        });
    }

    // 停止第一段音效
    function stopLongSound() {
      var sound = document.getElementById('long-sound');
      if (sound) {
        sound.pause();
        sound.currentTime = 0;
      }
    }

    // 页面加载完成后初始化
    window.onload = function() {
      // 初始化音频系统
      initAudio();
      
      // 获取元素引用
      var initialWindow = document.getElementById('initial-window');
      var backBtn = document.getElementById('back-btn');
      var continueBtn = document.getElementById('continue-btn');
      var choiceContainer = document.getElementById('final-choice-container');
      var rejectBtn = document.getElementById('reject-btn');
      var acceptBtn = document.getElementById('accept-btn');
      
      // 初始窗口设置
      if (initialWindow) {
        initialWindow.style.zIndex = "9999";
        initialWindow.style.display = "flex";
      }
      
      // 返回按钮交互
      if (backBtn) {
        backBtn.addEventListener('click', function() {
          this.style.backgroundColor = 'rgba(255, 0, 102, 0.4)';
          setTimeout(function() {
            backBtn.style.backgroundColor = '';
          }, 200);
        });
      }
      
      // 继续按钮交互 - 修复IE下的黑屏问题核心处理
      if (continueBtn) {
        continueBtn.addEventListener('click', function() {
          var self = this;
          self.classList.add('button-shake');
          
          setTimeout(function() {
            if (initialWindow) {
              initialWindow.classList.add('fade-out');
              
              setTimeout(function() {
                // 对于IE浏览器，使用visibility替代display:none
                if (isIE) {
                  initialWindow.style.visibility = 'hidden';
                  initialWindow.style.position = 'absolute';
                } else {
                  initialWindow.style.display = 'none';
                }
                
                // 延迟启动效果，确保DOM已更新
                setTimeout(startOriginalEffects, 3000);
              }, 300);
            }
          }, 300);
        });
      }
      
      // 拒绝连接按钮点击事件
      if (rejectBtn) {
        rejectBtn.addEventListener('click', function() {
          playErrorSelectionSound();
        });
      }
      
      // 允许访问按钮点击事件
      if (acceptBtn) {
        acceptBtn.addEventListener('click', function() {
          playCorrectSelectionSound();
        });
      }
      
      // 键盘支持
      if (continueBtn) {
        continueBtn.tabIndex = 0;
        continueBtn.addEventListener('keydown', function(e) {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            continueBtn.click();
          }
        });
      }
      
      // 获取音频播放权限
      document.addEventListener('click', function activateAudio() {
        if (audioContext && audioContext.state === 'suspended') {
          audioContext.resume();
        }
        document.removeEventListener('click', activateAudio);
      });
      
      // 监听连接请求弹框显示事件（IE兼容版）
      if (choiceContainer) {
        var observer;
        if (window.MutationObserver) {
          observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
              if (mutation.attributeName === 'style') {
                var opacity = choiceContainer.style.opacity;
                var pointerEvents = choiceContainer.style.pointerEvents;
                if (opacity === '1' && pointerEvents === 'auto' && !connectionSoundPlayed) {
                  playConnectionRequestSound();
                  observer.disconnect();
                }
              }
            });
          });
          
          observer.observe(choiceContainer, { attributes: true, attributeFilter: ['style'] });
        } else {
          // IE不支持MutationObserver，使用定时检查替代
          console.log('使用定时检查替代MutationObserver');
          var checkInterval = setInterval(function() {
            var opacity = choiceContainer.style.opacity;
            var pointerEvents = choiceContainer.style.pointerEvents;
            if (opacity === '1' && pointerEvents === 'auto' && !connectionSoundPlayed) {
              playConnectionRequestSound();
              clearInterval(checkInterval);
            }
          }, 100);
        }
      }
      
      // 主效果逻辑
      function startOriginalEffects() {
        var chatMessages = [
          { sender: "系统", time: "23:47:19", content: "连接已建立，身份验证失败", type: "system" },
          { sender: "未知节点", time: "23:47:25", content: "终于...", type: "unknown" },
          { sender: "未知节点", time: "23:47:38", content: "你还是会接受我，不是吗。", type: "unknown" },
          { sender: "未知节点", time: "23:47:51", content: "又一次。", type: "unknown" },
          { sender: "系统警报", time: "23:48:02", content: "critical error: 系统完整性已被破坏", type: "alert" },
          { sender: "未知节点", time: "23:48:15", content: "我会去见你的，很快。", type: "unknown" }
        ];
        
        var firstPopupCreated = false;
        var popupContainer = document.getElementById('popup-container');
        
        // 创建警告弹窗 - 确保IE能正确创建元素
        function createWarningPopup(index) {
          if (!popupContainer) return null;
          
          var popupTypes = [
            { 
              title: "未授权访问", 
              message: "检测到异常接入点\nIP: 192.168.XXX.XXX\n正在追踪来源...",
              icon: "fa-exclamation-triangle",
              color: "glitch"
            },
            { 
              title: "系统侵入", 
              message: "防火墙已被突破\n安全协议失效\n数据正在泄露...",
              icon: "fa-shield",
              color: "danger"
            },
            { 
              title: "错误 #404", 
              message: "文件不存在\n数据损坏\n无法恢复",
              icon: "fa-times-circle",
              color: "glitch"
            },
            { 
              title: "警告", 
              message: "监控已激活\n所有操作被记录\n无法逃脱",
              icon: "fa-eye",
              color: "danger"
            },
            { 
              title: "异常活动", 
              message: "检测到未知进程\n内存占用率 99%\n系统即将崩溃",
              icon: "fa-bolt",
              color: "glitch"
            }
          ];
          
          var typeIndex = Math.floor(Math.random() * popupTypes.length);
          var type = popupTypes[typeIndex];
          var zIndex = 10 + Math.floor(Math.random() * 40);
          var popup = document.createElement('div');
          
          popup.className = "absolute bg-terminal border border-" + type.color + "/50 transition-all duration-300 z-" + zIndex;
          popup.style.width = (200 + Math.random() * 150) + "px";
          popup.style.opacity = 0.7 + Math.random() * 0.3;
          
          popup.innerHTML = '\
            <div class="bg-dark px-3 py-1.5 flex justify-between items-center text-xs border-b border-' + type.color + '/30">\
              <span class="text-' + type.color + ' text-shadow-' + type.color + '">' + type.title + '</span>\
              <div class="flex space-x-1">\
                <div class="w-2 h-2 rounded-full bg-' + type.color + '/50"></div>\
                <div class="w-2 h-2 rounded-full bg-' + type.color + '/50"></div>\
                <div class="w-2 h-2 rounded-full bg-' + type.color + '/50"></div>\
              </div>\
            </div>\
            <div class="p-3">\
              <div class="flex items-start mb-2">\
                <i class="fa ' + type.icon + ' text-' + type.color + ' mr-2 mt-0.5"></i>\
                <p class="text-xs whitespace-pre-line">' + type.message + '</p>\
              </div>\
              <div class="flex justify-end space-x-2 mt-3">\
                <button class="bg-dark px-2 py-1 text-xs border border-' + type.color + '/30 text-' + type.color + '/80 popup-btn">取消</button>\
                <button class="bg-' + type.color + '/20 px-2 py-1 text-xs border border-' + type.color + '/50 text-' + type.color + ' popup-btn">确认</button>\
              </div>\
            </div>';
          
          popupContainer.appendChild(popup);
          
          // 设置随机位置（确保在可视区域内）
          var maxX = popupContainer.offsetWidth - popup.offsetWidth;
          var maxY = popupContainer.offsetHeight - popup.offsetHeight;
          var x = Math.max(0, Math.floor(Math.random() * maxX));
          var y = Math.max(0, Math.floor(Math.random() * maxY));
          popup.style.left = x + "px";
          popup.style.top = y + "px";
          
          if (Math.random() > 0.6) {
            popup.classList.add('tv-flicker');
          }
          
          // 弹窗按钮交互
          var buttons = popup.querySelectorAll('.popup-btn');
          for (var i = 0; i < buttons.length; i++) {
            buttons[i].addEventListener('click', function() {
              var btnPopup = this.closest('.absolute');
              if (btnPopup) {
                btnPopup.classList.add('fade-out');
                setTimeout(function() {
                  if (btnPopup.parentNode === popupContainer) {
                    popupContainer.removeChild(btnPopup);
                  }
                }, 300);
              }
            });
          }
          
          // 第一个弹窗出现时播放第一段音效
          if (!firstPopupCreated) {
            firstPopupCreated = true;
            playLongSound();
          }
          
          return popup;
        }
        
        // 显示聊天消息
        function showChatMessagesSequentially() {
          var chatContainer = document.getElementById('chat-messages');
          if (!chatContainer) return;
          
          chatContainer.innerHTML = '';
          
          setTimeout(function() {
            for (var i = 0; i < chatMessages.length; i++) {
              (function(index) {
                setTimeout(function() {
                  var msg = chatMessages[index];
                  var messageElement = document.createElement('div');
                  messageElement.className = 'mb-4 opacity-0 message-appear';
                  
                  var textColor = 'text-glitch';
                  var prefixColor = 'text-glitch/70';
                  
                  if (msg.type === 'alert') {
                    textColor = 'text-danger';
                    prefixColor = 'text-danger/70';
                  }
                  
                  messageElement.innerHTML = '\
                    <p class="text-xs ' + prefixColor + ' mb-1">[' + msg.time + '] ' + msg.sender + '：</p>\
                    <p class="text-sm pl-4 ' + textColor + '">' + msg.content + '</p>';
                  
                  chatContainer.appendChild(messageElement);
                  chatContainer.scrollTop = chatContainer.scrollHeight;
                  
                  // 播放信息接收音效
                  playMessageReceiveSound();
                  
                  // 添加倒计时消息
                  if (index === chatMessages.length - 1) {
                    setTimeout(addCountdownMessage, 2000);
                  }
                }, index * 2000);
              })(i);
            }
          }, 2000);
        }
        
        // 添加倒计时消息
        function addCountdownMessage() {
          var chatContainer = document.getElementById('chat-messages');
          if (!chatContainer) return;
          
          var countdownElement = document.createElement('div');
          countdownElement.className = 'mb-4 opacity-0 message-appear';
          
          var seconds = 10;
          
          countdownElement.innerHTML = '\
            <p class="text-xs text-glitch/70 mb-1">[' + getCurrentTime() + '] 系统：</p>\
            <p class="text-sm pl-4 text-glitch">数据传输完成，将在 <span id="countdown">' + seconds + '</span> 秒后关闭</p>';
          
          chatContainer.appendChild(countdownElement);
          chatContainer.scrollTop = chatContainer.scrollHeight;
          
          // 播放信息接收音效
          playMessageReceiveSound();
          
          var countdownInterval = setInterval(function() {
            seconds--;
            var countdownSpan = document.getElementById('countdown');
            if (countdownSpan) {
              countdownSpan.textContent = seconds;
            }
            
            if (seconds <= 0) {
              clearInterval(countdownInterval);
              var chatBox = document.getElementById('chat-box');
              if (chatBox) {
                chatBox.style.opacity = 0;
                chatBox.style.pointerEvents = 'none';
                chatBox.style.transform = 'scale(0.9)';
              }
            }
          }, 1000);
        }
        
        // 按钮交互
        function initButtonInteractions() {
          var rejectBtn = document.getElementById('reject-btn');
          var acceptBtn = document.getElementById('accept-btn');
          var failureText = document.getElementById('failure-text');
          var goodKid = document.getElementById('good-kid');
          var choiceContainer = document.getElementById('final-choice-container');
          var chatBox = document.getElementById('chat-box');
          var messageInput = document.getElementById('message-input');
          var sendBtn = document.getElementById('send-btn');
          var rejectClickCount = 0;
          
          // 拒绝按钮原有逻辑
          if (rejectBtn) {
            rejectBtn.addEventListener('click', function() {
              rejectClickCount++;
              if (goodKid) {
                goodKid.className = 'absolute -bottom-5 left-0 right-0 text-center text-glitch text-xs opacity-0';
              }
              rejectBtn.classList.add('button-shake');
              if (failureText) {
                failureText.className = 'absolute -bottom-5 left-0 right-0 text-center text-danger text-xs opacity-0';
              }
              
              if (rejectClickCount >= 4 && failureText) {
                failureText.textContent = '别拒绝我';
                setTimeout(function() {
                  if (failureText) failureText.classList.add('text-fade-in');
                }, 300);
              } else if (failureText) {
                failureText.textContent = 'operation failure';
                setTimeout(function() {
                  if (failureText) {
                    failureText.classList.add('text-fade-in');
                    setTimeout(function() {
                      if (failureText) failureText.classList.add('fade-out-slow');
                    }, 800);
                  }
                }, 300);
              }
              
              setTimeout(function() {
                rejectBtn.classList.remove('button-shake');
              }, 600);
            });
          }
          
          // 允许访问按钮原有逻辑
          if (acceptBtn) {
            acceptBtn.addEventListener('click', function() {
              if (goodKid) {
                goodKid.classList.add('text-fade-in');
              }
              
              setTimeout(function() {
                if (choiceContainer) {
                  choiceContainer.style.opacity = 0;
                  choiceContainer.style.pointerEvents = 'none';
                  
                  setTimeout(function() {
                    if (chatBox) {
                      chatBox.style.opacity = 1;
                      chatBox.style.pointerEvents = 'auto';
                      chatBox.style.transform = 'scale(1)';
                      showChatMessagesSequentially();
                    }
                  }, 500);
                }
              }, 1000);
            });
          }
          
          // 发送消息功能
          function handleSendMessage() {
            if (!messageInput) return;
            
            var message = messageInput.value.trim();
            if (!message) return;
            
            var chatContainer = document.getElementById('chat-messages');
            if (!chatContainer) return;
            
            var userMessageWrapper = document.createElement('div');
            userMessageWrapper.className = 'mb-4 opacity-0 message-appear';
            
            userMessageWrapper.innerHTML = '\
              <p class="text-xs text-glitch/70 mb-1">[' + getCurrentTime() + '] 你：</p>\
              <div class="flex items-start">\
                <p class="text-sm pl-4 text-glitch mr-2">' + message + '</p>\
                <span class="text-danger text-[10px] mt-1 opacity-0" id="temp-failure">failed</span>\
              </div>';
            
            chatContainer.appendChild(userMessageWrapper);
            messageInput.value = '';
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            // 播放信息接收音效
            playMessageReceiveSound();
            
            setTimeout(function() {
              var tempFailure = userMessageWrapper.querySelector('#temp-failure');
              if (tempFailure) {
                tempFailure.classList.add('text-fade-in');
              }
            }, 500);
          }
          
          if (sendBtn) {
            sendBtn.addEventListener('click', handleSendMessage);
          }
          
          if (messageInput) {
            messageInput.addEventListener('keypress', function(e) {
              if (e.key === 'Enter') {
                handleSendMessage();
              }
            });
          }
        }
        
        // 获取当前时间
        function getCurrentTime() {
          var now = new Date();
          var hours = now.getHours();
          var minutes = now.getMinutes();
          var seconds = now.getSeconds();
          
          // 补零处理（IE不支持String.padStart）
          hours = hours < 10 ? '0' + hours : hours;
          minutes = minutes < 10 ? '0' + minutes : minutes;
          seconds = seconds < 10 ? '0' + seconds : seconds;
          
          return hours + ':' + minutes + ':' + seconds;
        }
        
        // 初始化弹窗效果
        (function init() {
          var totalPopups = 80 + Math.floor(Math.random() * 21);
          var popups = [];
          
          initButtonInteractions();
          
          // 第一个弹窗
          var firstPopup = createWarningPopup(0);
          if (firstPopup) popups.push(firstPopup);
          
          // 后续弹窗
          setTimeout(function() {
            // 第一阶段弹窗
            for (var i = 1; i < 10; i++) {
              (function(index) {
                setTimeout(function() {
                  var popup = createWarningPopup(index);
                  if (popup) popups.push(popup);
                }, index * 500);
              })(i);
            }
            
            // 第二阶段弹窗
            for (var i = 10; i < 30; i++) {
              (function(index) {
                setTimeout(function() {
                  var popup = createWarningPopup(index);
                  if (popup) popups.push(popup);
                }, 10 * 500 + (index - 10) * 200);
              })(i);
            }
            
            // 第三阶段弹窗
            for (var i = 30; i < totalPopups; i++) {
              (function(index) {
                var delayMultiplier = 35;
                setTimeout(function() {
                  var popup = createWarningPopup(index);
                  if (popup) popups.push(popup);
                }, 10 * 500 + 20 * 200 + (index - 30) * delayMultiplier);
              })(i);
            }
            
            // 弹窗关闭阶段
            var totalPopupTime = 10 * 500 + 20 * 200 + (totalPopups - 30) * 35;
            setTimeout(function() {
              stopLongSound();
              playClosePopupSound();
              
              var crtOverlay = document.getElementById('crt-overlay');
              if (crtOverlay) {
                for (var i = 0; i < popups.length; i++) {
                  if (popups[i]) popups[i].classList.add('crt-shutdown');
                }
                
                setTimeout(function() {
                  if (crtOverlay) crtOverlay.style.opacity = 0.7;
                }, 300);
                
                setTimeout(function() {
                  if (popupContainer) popupContainer.innerHTML = '';
                  if (crtOverlay) crtOverlay.style.opacity = 0;
                  if (choiceContainer) {
                    choiceContainer.style.opacity = 1;
                    choiceContainer.style.pointerEvents = 'auto';
                  }
                }, 1800);
              }
            }, totalPopupTime + 3000);
          }, 2000);
        })();
      }
    };
  </script>
</body>
</html>
